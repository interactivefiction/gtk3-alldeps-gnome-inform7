<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Generated by indoc on 24 Dec 2015 -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link href="indoc_WI.css" rel="stylesheet" type="text/css" />
<title>23.15. Exchanging files with other programs</title>
<script type="text/javascript">
    function showExtra(id, imid) {
        if (document.getElementById(id).style.display == 'block') {
            document.getElementById(id).style.display = 'none';
            document.getElementById(imid).src = 'inform:/doc_images/extra.png';
        } else {
            document.getElementById(id).style.display = 'block';
            document.getElementById(imid).src = 'inform:/doc_images/extraclose.png';
        }
    }
    function onLoaded() {
        if (window.location.hash) {
            var hash = window.location.hash.substring(2);
            if (hash.search("_") >= 0) {
                var res = hash.split("_");
                showExample("example"+res[1]);
            } else {
                showExample("example"+hash);
            }
        }
    }
    window.onload=onLoaded;
    function showExample(id) {
        if (document.getElementById(id).style.display == 'block') {
            document.getElementById(id).style.display = 'none';
        } else {
            document.getElementById(id).style.display = 'block';
        }
    }
    function openExtra(id, imid) {
        document.getElementById(id).style.display = 'block';
        document.getElementById(imid).src = 'inform:/doc_images/extraclose.png';
    }
    function closeExtra(id, imid) {
        document.getElementById(id).style.display = 'none';
        document.getElementById(imid).src = 'inform:/doc_images/extra.png';
    }
</script>
</head>
<body class="paper papertint"><script language="JavaScript">
function pasteCode(code) {
    var myProject = window.Project;

    myProject.selectView('source');
    myProject.pasteCode(code);
}
</script>
<script language="JavaScript">
function createNewProject(code, title) {
    var myProject = window.Project;

    myProject.createNewProject(title, code);
}
</script>

<!-- SEARCH TITLE "Exchanging files with other programs" -->
<!-- SEARCH SECTION "23.15" -->
<!-- SEARCH SORT "000-023-015-000" -->
<!-- START IGNORE 386 -->
<div class="bookheader">
<table class="fullwidth midnightblack"><tr><td class="midnightbannerleftcell"><a href="doc386.html" class="standardlink"><img alt="Hookleft.png" src="inform:/doc_images/Hookleft.png" id="hookleft" /></a></td><td class="midnightbannercentrecell"><a href="index.html" class="standardlink"><span class="midnightbannertext">Chapter 23: Figures, Sounds and Files</span></a></td><td class="midnightbannerrightcell"><a href="index.html" class="standardlink"><img alt="Hookup.png" src="inform:/doc_images/Hookup.png" id="hookup" /></a><a href="doc388.html" class="standardlink"><img alt="Hookright.png" src="inform:/doc_images/Hookright.png" id="hookright" /></a></td></tr></table></div>
<!-- END IGNORE -->
<p class="sectionheading">ยง23.15. Exchanging files with other programs</p>
<p>Provided we declare the files in the right way, it is easy for one project to read a file created by another project.</p>
<p>But if we want more rapid communication, between two projects which are each playing at the same time, we need to be more careful. What if project A tries to read the file at the same moment that project B is writing it?</p>
<p>To avoid this, we have a concept of files being &quot;ready&quot;. A file is ready if it exists, and is completely written, and not in use elsewhere. We have already seen:</p>
<!-- START CODE "c8856" -->
<a id="c8856"></a><blockquote class="code"><p class="quoted">
if the file of Invariants exists...
</p></blockquote>
<!-- END CODE -->
<p>But now we want a stronger condition:</p>
<!-- START PHRASE "defn375" -->
<div class="definition"><a id="defn375"></a><p class="defnprototype"><b>if ready to read </b>(external file)<b>:</b></p>
<!-- END PHRASE -->
<!-- definition of ph_fileready -->

<p>This condition is true if the file exists and is marked as being ready to read; that is, it is not in a state where another program is currently writing it. Example:</p>
<!-- START CODE "c8857" -->
<a id="c8857"></a><blockquote class="code"><p class="quoted">
if ready to read the file of Invariants, ...
</p></blockquote>
<!-- END CODE -->

<!-- end definition -->
</div>

<p>A file cannot be ready to read if it does not exist, so this is a stronger condition. If A and B are attempting communication in real time, both running at once, then Project A should check that an external file owned by B is ready before it tries to read it. Files can also be marked as ready or not ready, in effect claiming them, thus:</p>
<!-- START PHRASE "defn376" -->
<div class="definition"><a id="defn376"></a><p class="defnprototype"><b>mark </b>(external file)<b> as ready to read</b></p>
<!-- END PHRASE -->
<!-- definition of ph_markfileready -->

<p>This phrase marks that we have finished writing to the given file, so that any external program is welcome to read it now. Example:</p>
<!-- START CODE "c8858" -->
<a id="c8858"></a><blockquote class="code"><p class="quoted">
mark the file of Invariants as ready to read;
</p></blockquote>
<!-- END CODE -->

<!-- end definition -->
</div>

<!-- START PHRASE "defn377" -->
<div class="definition"><a id="defn377"></a><p class="defnprototype"><b>mark </b>(external file)<b> as not ready to read</b></p>
<!-- END PHRASE -->
<!-- definition of ph_markfilenotready -->

<p>This phrase marks that we are about to start writing to the given file, so that any external program should wait until we're finished if it wants to read the file. Example:</p>
<!-- START CODE "c8859" -->
<a id="c8859"></a><blockquote class="code"><p class="quoted">
mark the file of Invariants as not ready to read;
</p></blockquote>
<!-- END CODE -->

<!-- end definition -->
</div>

<p>Possibilities really begin to open up when project A is our story file, but B is not another story file at all: it is some external program such as a Web service, say. (Of course this is harder to set up, since the player needs to have both A and B running at the same time, but for stories running on an Internet server this can all be made seamless.)</p>
<p>When Inform begins writing a table, or text, to a file, it initially marks the file as not ready: only when the table or text is completely written and the file about to close is the file marked as ready.</p>
<p>In order to write non-story-file programs as B, communicating with story files as A, we need to know the file format used by Inform. An Inform file is currently a Unix text file (with 10 as the line division character), encoded as ASCII Latin-1. (We would like to use Unicode at some point in the future, but the Glk and Glulx layers are still not fully converted to Unicode.) It opens with a single header line in the form:</p>
<!-- START CODE "c8860" -->
<a id="c8860"></a><blockquote class="code"><p class="quoted">
* //IFID// leafname
</p></blockquote>
<!-- END CODE -->
<p>The opening character is an asterisk if the file is currently ready, a hyphen if the file is currently not ready. The IFID between the slashes is the IFID number of the project which last wrote to the file. (Marking &quot;ready&quot; or &quot;not ready&quot; does not count as a write for this purpose.) If an external program wrote the file, it should call itself something which will not clash with any story file's IFID. The leafname is the filename text used inside the story file where the file was declared. For instance:</p>
<!-- START CODE "c8861" -->
<a id="c8861"></a><blockquote class="code"><p class="quoted">
* //4122DDA8-A153-46BC-8F57-42220F9D8795// ice
</p></blockquote>
<!-- END CODE -->
<hr />
<div class="bookexamples">
<p class="chapterheading"></p><!-- START EXAMPLE "445: Flathead News Network" "e339" -->
<a id="e339"></a><table class="egcue"><tr><td class="egcellforoval"><div class="egovalfornumber overstruckimage">
<a href="#" class="eglink" onclick="showExample('example339'); return false;"><b>445</b></a></div>
</td><td class="egnamecell"><p class="egcuetext"><a href="#" class="eglink" onclick="showExample('example339'); return false;"><img class="asterisk" alt="*" src="inform:/doc_images/asterisk.png" /><img class="asterisk" alt="*" src="inform:/doc_images/asterisk.png" /><img class="asterisk" alt="*" src="inform:/doc_images/asterisk.png" /><b><span class="egbanner">Example</span><span class="egname">Flathead News Network</span></b></a><br />Using external files, together with a simple Unix script running in the background, to provide live news headlines inside a story file.</p></td><td class="egcrossref"><!-- START IGNORE -->
<div class="egovalforxref overstruckimage">
<a  href="Rdoc101.html#e339"><i>RB</i></a></div>
<!-- END IGNORE -->
</td></tr></table>
<div class="egpanel" id="example339" style="display: none;">
<p>This example can only work if we have a separate program running in the background while the story file is being played, and as such it will only work if we set things up in a special way. Exactly how to do this will vary from platform to platform.</p>
<p>First, the source text for the Inform end of the communication line:</p>
<!-- START CODE "c8862_339" -->
<a id="c8862_339"></a><blockquote class="code"><p class="quoted">
<a href="javascript:pasteCode('[=0x0022=]Flathead News Network[=0x0022=][=0x000A=][=0x000A=]The file of RSS Requests is called [=0x0022=]rssrequest[=0x0022=].[=0x000A=][=0x000A=]The file of RSS Responses (owned by project [=0x0022=]RSS-SCRIPT[=0x0022=]) is called [=0x0022=]rssreply[=0x0022=].[=0x000A=][=0x000A=]To request (RSS feed address - text):[=0x000A=][=0x0009=]mark the file of RSS Responses as not ready to read;[=0x000A=][=0x0009=]write the RSS feed address to the file of RSS Requests.[=0x000A=][=0x000A=]Newsroom is a room. [=0x0022=]This is the secret nerve-centre of FNN, the Flathead News Network.[=0x0022=][=0x000A=][=0x000A=]The BBC button is in the Newsroom. Instead of pushing the BBC button: say [=0x0022=]Bong![=0x0022=]; request [=0x0022=]newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml[=0x0022=].[=0x000A=][=0x000A=]The NASA button is in the Newsroom. Instead of pushing the NASA button: say [=0x0022=]Bang![=0x0022=]; request [=0x0022=]www.nasa.gov/rss/breaking_news.rss[=0x0022=].[=0x000A=][=0x000A=]The WHO button is in the Newsroom. Instead of pushing the WHO button: say [=0x0022=]Bing![=0x0022=]; request [=0x0022=]http://www.doctorwhonews.net[=0x0022=].[=0x000A=][=0x000A=]A screen is in the Newsroom.[=0x000A=][=0x000A=]Instead of examining the screen:[=0x000A=][=0x0009=]if ready to read the file of RSS Responses, say [=0x0022=]From the screen you read:[line break][text of the file of RSS Responses][=0x0022=];[=0x000A=][=0x0009=]otherwise say [=0x0022=]The screen remains blank for now.[=0x0022=][=0x000A=][=0x000A=]\n')"><img alt="paste.png" src="inform:/doc_images/paste.png" /></a> &quot;Flathead News Network&quot;
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8863_339" -->
<a id="c8863_339"></a><blockquote class="code"><p class="quoted">
The file of RSS Requests is called &quot;rssrequest&quot;.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8864_339" -->
<a id="c8864_339"></a><blockquote class="code"><p class="quoted">
The file of RSS Responses (owned by project &quot;RSS-SCRIPT&quot;) is called &quot;rssreply&quot;.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8865_339" -->
<a id="c8865_339"></a><blockquote class="code"><p class="quoted">
To request (RSS feed address - text):
<br />&#160;&#160;&#160;&#160;mark the file of RSS Responses as not ready to read;
<br />&#160;&#160;&#160;&#160;write the RSS feed address to the file of RSS Requests.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8866_339" -->
<a id="c8866_339"></a><blockquote class="code"><p class="quoted">
Newsroom is a room. &quot;This is the secret nerve-centre of FNN, the Flathead News Network.&quot;
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8867_339" -->
<a id="c8867_339"></a><blockquote class="code"><p class="quoted">
The BBC button is in the Newsroom. Instead of pushing the BBC button: say &quot;Bong!&quot;; request &quot;newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml&quot;.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8868_339" -->
<a id="c8868_339"></a><blockquote class="code"><p class="quoted">
The NASA button is in the Newsroom. Instead of pushing the NASA button: say &quot;Bang!&quot;; request &quot;www.nasa.gov/rss/breaking_news.rss&quot;.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8869_339" -->
<a id="c8869_339"></a><blockquote class="code"><p class="quoted">
The WHO button is in the Newsroom. Instead of pushing the WHO button: say &quot;Bing!&quot;; request &quot;http://www.doctorwhonews.net&quot;.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8870_339" -->
<a id="c8870_339"></a><blockquote class="code"><p class="quoted">
A screen is in the Newsroom.
</p></blockquote>
<!-- END CODE -->
<!-- START CODE "c8871_339" -->
<a id="c8871_339"></a><blockquote class="code"><p class="quoted">
Instead of examining the screen:
<br />&#160;&#160;&#160;&#160;if ready to read the file of RSS Responses, say &quot;From the screen you read:[line break][text of the file of RSS Responses]&quot;;
<br />&#160;&#160;&#160;&#160;otherwise say &quot;The screen remains blank for now.&quot;
</p></blockquote>
<!-- END CODE -->
<p>As far as the story file is concerned, then, it sends a request down the communication line by writing the chosen RSS feed to the file named &quot;rssrequest&quot;, and expects a reply to come back down the line by being written to the file &quot;rssreply&quot;. However, the story file needs to expect that this might take some time. (Maybe forever, if there is no program responding, or if the Internet connection is not working.) The story file marks the &quot;rssreply&quot; file as not ready before it makes a request; if it subsequently finds that the file is now ready, that must mean that the other program has done the honours, and that all is well. In the mean time, &quot;The screen remains blank for now.&quot;</p>
<p>Now for the RSS-SCRIPT program. The following provides a crude but workable program suitable for running as a Perl script on a system which provides the standard Internet fetching program &quot;curl&quot;: Mac OS X, for instance. (If you have OS X, you can paste the following into a (Unix-format) text file called &quot;rss-script.pl&quot;, place it in your home folder, open the Terminal utility, type &quot;perl rss-script.pl&quot;, and then hide the Terminal window again.)</p>
<!-- START CODE "c8872_339" -->
<a id="c8872_339"></a><blockquote class="code"><p class="quoted">
for (;;) { # repeat forever:
<br />&#160;&#160;&#160;&#160;system(&quot;sleep 1&quot;); # wait 1 second
<br />&#160;&#160;&#160;&#160;open REQUEST, &quot;rssrequest.glkdata&quot; or next;
<br />&#160;&#160;&#160;&#160;# the request file has been detected:
<br />&#160;&#160;&#160;&#160;$header_line = &lt;REQUEST&gt;; # the header line
<br />&#160;&#160;&#160;&#160;$rss_feed = &lt;REQUEST&gt;; # the actual content - the RSS feed URL
<br />&#160;&#160;&#160;&#160;close REQUEST;
<br />&#160;&#160;&#160;&#160;if ($header_line =~ m/^\*/) { # if the request file is marked ready
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$rss = system(&quot;curl $rss_feed &gt;rawrss.txt&quot;); # download the RSS feed
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;# read the RSS XML into a single Perl string:
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;open RAWRSS, &quot;rawrss.txt&quot; or next;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$raw = &quot;&quot;;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;while ($nl = &lt;RAWRSS&gt;) {
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$raw = $raw.&quot; &quot;.$nl;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;close RAWRSS;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;# look for the title and description of the first item:
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if ($raw =~ m/\&lt;item\&gt;\&lt;title.*?\&gt;(.*?)\&lt;\/title\&gt;.*?\&lt;description.*?\&gt;(.*?)\&lt;\/description\&gt;/) {
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;# write the reply:
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;open REPLY, &quot;&gt;rssreply.glkdata&quot; or next;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print REPLY &quot;* //RSS-SCRIPT// rssreply\n&quot;, $1, &quot;\n&quot;, $2, &quot;\n&quot;;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;close REPLY;
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;# request safely dealt with, so we can remove it:
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;system(&quot;rm 'rssrequest.glkdata'&quot;);
<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
<br />&#160;&#160;&#160;&#160;}
<br />}
</p></blockquote>
<!-- END CODE -->
</div>
<p></p>
<!-- END EXAMPLE -->
<hr />
</div>
<!-- START IGNORE -->
<div class="bookfooter">
<table class="fullwidth"><tr><td class="footerprevious"><a href="doc386.html" class="footerlink">Previous</a></td><td class="footercontents"><a href="index.html" class="footerlink">Contents</a></td><td class="footernext"><a href="doc388.html" class="footerlink">Next</a></td></tr></table>
</div>
<!-- END IGNORE -->
</body>
</html>
